<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>EStore</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
			crossorigin="anonymous"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
			integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		/>
	</head>
	<body>
		<header id="header"></header>

		<div class="container">
			<h1>Products</h1>
			<div id="add-prod-button"></div>
			<table class="table">
				<thead>
					<tr>
						<th scope="col">#</th>
						<th scope="col">Category</th>
						<th scope="col">Name</th>
						<th scope="col">Weight</th>
						<th scope="col">Unit Price</th>
						<th scope="col">Unit In Stock</th>
						<th scope="col"></th>
					</tr>
				</thead>
				<tbody id="product-table" class="table-group-divider"></tbody>
			</table>

			<!-- Add Product Modal -->
			<div
				class="modal fade"
				id="addProductModal"
				tabindex="-1"
				aria-labelledby="addProductModalLabel"
				aria-hidden="true"
			>
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1
								class="modal-title fs-5"
								id="addProductModalLabel"
							>
								Add Product
							</h1>
							<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"
								aria-label="Close"
							></button>
						</div>
						<div class="modal-body">
							<form id="add-prod-form">
								<div id="category" class="mb-3">
									<label
										for="category-name"
										class="col-form-label"
										>Category:</label
									>
									<select
										id="category-name"
										class="form-select"
										aria-label="Default select example"
									>
										<option selected>Category</option>
									</select>
								</div>
								<div class="mb-3">
									<label
										for="product-name"
										class="col-form-label"
										>Name:</label
									>
									<input
										type="text"
										class="form-control"
										id="product-name"
									/>
								</div>
								<div class="mb-3">
									<label
										for="product-weight"
										class="col-form-label"
										>Weight:</label
									>
									<input
										type="number"
										class="form-control"
										id="product-weight"
									/>
								</div>
								<div class="mb-3">
									<label
										for="product-unit-price"
										class="col-form-label"
										>Unit Price:</label
									>
									<input
										type="number"
										class="form-control"
										id="product-unit-price"
										step="0.1"
									/>
								</div>
								<div class="mb-3">
									<label
										for="product-unit-in-stock"
										class="col-form-label"
										>Unit In Stock:</label
									>
									<input
										type="number"
										class="form-control"
										id="product-unit-in-stock"
									/>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							<button
								type="button"
								class="btn btn-secondary"
								data-bs-dismiss="modal"
							>
								Close
							</button>
							<button
								id="add-prod-btn"
								type="button"
								class="btn btn-primary"
							>
								Add
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Update Product Modal -->
			<div
				class="modal fade"
				id="updateProductModal"
				tabindex="-1"
				aria-labelledby="updateProductModalLabel"
				aria-hidden="true"
			>
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1
								class="modal-title fs-5"
								id="updateProductModalLabel"
							>
								Update Product
							</h1>
							<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"
								aria-label="Close"
							></button>
						</div>
						<div class="modal-body">
							<form>
								<div id="category" class="mb-3">
									<label
										for="category-name-update"
										class="col-form-label"
										>Category:</label
									>
									<select
										id="category-name-update"
										class="form-select"
										aria-label="Default select example"
									>
										<option selected>Category</option>
									</select>
								</div>
								<div class="mb-3">
									<label
										for="product-name-update"
										class="col-form-label"
										>Name:</label
									>
									<input
										type="text"
										class="form-control"
										id="product-name-update"
									/>
								</div>
								<div class="mb-3">
									<label
										for="product-weight-update"
										class="col-form-label"
										>Weight:</label
									>
									<input
										type="number"
										class="form-control"
										id="product-weight-update"
									/>
								</div>
								<div class="mb-3">
									<label
										for="product-unit-price-update"
										class="col-form-label"
										>Unit Price:</label
									>
									<input
										type="number"
										class="form-control"
										id="product-unit-price-update"
										step="0.1"
									/>
								</div>
								<div class="mb-3">
									<label
										for="product-unit-in-stock-update"
										class="col-form-label"
										>Unit In Stock:</label
									>
									<input
										type="number"
										class="form-control"
										id="product-unit-in-stock-update"
									/>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							<button
								type="button"
								class="btn btn-secondary"
								data-bs-dismiss="modal"
							>
								Close
							</button>
							<button
								id="update-prod-btn"
								type="button"
								class="btn btn-primary"
							>
								Save
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../vendor/jquery/jquery.min.js"></script>
		<script src="../js/jwt-decode.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
			crossorigin="anonymous"
		></script>
		<script>
			$(() => {
				$("#header").load("./utils/header.html");
			});

			var token = localStorage.getItem("token");
			var decoded;
			var userRole;

			$(document).ready(() => {
				if (token != null) {
					decoded = jwt_decode(token);
					userRole =
						decoded[
							"http://schemas.microsoft.com/ws/2008/06/identity/claims/role"
						];

					if (userRole == "Admin") {
						$("#add-prod-button").append(
							`<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
								Add Product
							</button>`
						);
					}

					$("#add-prod-btn").click(() => {
						let product = {
							categoryId: $("#category-name").val(),
							productName: $("#product-name").val(),
							weight: $("#product-weight").val(),
							unitPrice: $("#product-unit-price").val(),
							unitInStock: $("#product-unit-in-stock").val(),
						};
						$.ajax({
							url: "https://localhost:7135/api/Product/AddProduct",
							method: "POST",
							contentType: "application/json",
							data: JSON.stringify(product),
							headers: {
								Authorization: "Bearer " + token,
							},
							success: (response) => {
								SlimNotifierJs.notification(
									"success",
									"Added Successfully!",
									response,
									3000
								);
								loadProducts(userRole);
								$("#category-name").val("")
								$("#product-name").val("")
								$("#product-weight").val("")
								$("#product-unit-price").val("")
								$("#product-unit-in-stock").val("")
							},
							error: function (xhr, status, error) {
								SlimNotifierJs.notification(
									"error",
									"Error",
									xhr.responseText,
									3000
								);
							},
						});
					});

					loadProducts(userRole);
				} else {
					loadProducts("");
				}

				$.ajax({
					url: "https://localhost:7135/api/Category/GetAllCate",
					method: "GET",
					contentType: "application/json",
					success: (response) => {
						$("#category-name").append(
							response.map(
								(cat) =>
									`<option value="${cat.categoryId}">${cat.categoryName}</option>`
							)
						);
						$("#category-name-update").append(
							response.map(
								(cat) =>
									`<option value="${cat.categoryId}">${cat.categoryName}</option>`
							)
						);
					},
					error: function (xhr, status, error) {
						SlimNotifierJs.notification(
							"error",
							"Error",
							xhr.responseText,
							3000
						);
					},
				});
			});

			function loadProducts(role) {
				$.ajax({
					url: "https://localhost:7135/api/Product/GetAllProducts",
					method: "GET",
					contentType: "application/json",
					success: (response) => {
						$("#product-table").empty();
						if (role === "Admin") {
							$("#product-table").append(
								response.map(
									(product) =>
										`<tr>
											<th scope="row">${product.productId}</th>
											<td>${product.category}</td>
											<td>${product.productName}</td>
											<td>${product.weight}</td>
											<td>${product.unitPrice}$</td>
											<td>${product.unitInStock}</td>
											<td>
												<button type="button" class="btn btn-success" data-bs-toggle="modal"
														data-bs-target="#updateProductModal"
														data-prod-id="${product.productId}"
														data-prod-cate="${product.categoryId}"
														data-prod-name="${product.productName}"
														data-prod-weight="${product.weight}"
														data-prod-unit-price="${product.unitPrice}"
														data-prod-unit-in-stock="${product.unitInStock}"
														onclick="updateProd(this)">
													<i class="fa-solid fa-pen-to-square"></i>
												</button>
												<button type="button" class="btn btn-danger" data-prod-id="${product.productId}"
														onclick="deleteProd(this)">
													<i class="fa-solid fa-trash"></i>
												</button>
											</td>
										</tr>`
								)
							);
						} else {
							$("#product-table").append(
								response.map(
									(product) =>
										`<tr>
											<th scope="row">${product.productId}</th>
											<td>${product.category}</td>
											<td>${product.productName}</td>
											<td>${product.weight}</td>
											<td>${product.unitPrice}$</td>
											<td>${product.unitInStock}</td>
											<td>
												<i class="fa-solid fa-cart-shopping"></i>
											</td>
										</tr>`
								)
							);
						}
					},
					error: function (xhr, status, error) {
						SlimNotifierJs.notification(
							"error",
							"Error",
							xhr.responseText,
							3000
						);
					},
				});
			}

			var prodId;
			var updatedProduct;
			var currentProduct;

			function updateProd(model) {
				currentProduct = {
					categoryId: model.getAttribute("data-prod-cate"),
					productName: model.getAttribute("data-prod-name"),
					weight: model.getAttribute("data-prod-weight"),
					unitPrice: model.getAttribute("data-prod-unit-price"),
					unitInStock: model.getAttribute("data-prod-unit-in-stock"),
				};

				$("#category-name-update").val(currentProduct.categoryId);
				$("#product-name-update").val(currentProduct.productName);
				$("#product-weight-update").val(currentProduct.weight);
				$("#product-unit-price-update").val(currentProduct.unitPrice);
				$("#product-unit-in-stock-update").val(currentProduct.unitInStock);

				prodId = model.getAttribute("data-prod-id");
			}

			function deleteProd(model) {
				prodId = model.getAttribute("data-prod-id");
				$.ajax({
					url: "https://localhost:7135/api/Product/DeleteProduct/" + prodId,
					method: "DELETE",
					contentType: "application/json",
					headers: {
						Authorization: "Bearer " + token,
					},
					success: (response) => {
						SlimNotifierJs.notification(
							"success",
							"Updated Successfully!",
							response,
							3000
						);
						loadProducts(userRole);
					},
					error: function (xhr, status, error) {
						SlimNotifierJs.notification(
							"error",
							"Error",
							xhr.responseText,
							3000
						);
					},
				})
			}

			$("#update-prod-btn").click(() => {
				updatedProduct = {
					categoryId: $("#category-name-update").val(),
					productName: $("#product-name-update").val(),
					weight: $("#product-weight-update").val(),
					unitPrice: $("#product-unit-price-update").val(),
					unitInStock: $("#product-unit-in-stock-update").val(),
				};

				$.ajax({
					url:
						"https://localhost:7135/api/Product/UpdateProduct/" +
						prodId,
					method: "PUT",
					contentType: "application/json",
					data: JSON.stringify(updatedProduct),
					headers: {
						Authorization: "Bearer " + token,
					},
					success: (response) => {
						SlimNotifierJs.notification(
							"success",
							"Updated Successfully!",
							response,
							3000
						);
						loadProducts(userRole);
					},
					error: function (xhr, status, error) {
						SlimNotifierJs.notification(
							"error",
							"Error",
							xhr.responseText,
							3000
						);
					},
				});
			});
		</script>
	</body>
</html>
